#!/usr/bin/env ruby

$:.unshift File.expand_path("../../lib", __FILE__)

require "joplin"
require 'thor'


class MyCLI < Thor
  class_option :token, :type => :string #, required: true
  class_option :help, :type => :boolean
  class_option :version, :type => :boolean
  map ["-v", "--version"] => :version
  map ["-h", "--help"] => :help
  option :token, :required => true
  option :'dry-run', desc: "dry-run", aliases: '-n'
  desc :clean, "clean unused resources"
  def clean
    Joplin::token = options[:token]
    Joplin::Resource.orphaned.map { |r|
      r.delete if not options['dry-run']
      puts "Deleted #{r.id}"
    }
  end

  method_options :force => :boolean
  desc "version", "get version of program"
  def version
    puts Joplin::VERSION
  end

  desc :nb2n, "concate all notes in a notebook to one note. Possible PDF export"
  option :token, :required => true
  option :type, :type => :string
  def nb2n(query)
    Joplin::token = options[:token]
    results = Joplin.search(query, { type: 'folder' })
    nb = results[0];
    if not (nb and nb['title'] == query)
      abort "notebook #{query} not found"
    end

    notebook = Joplin::Notebook.new nb['id']
    notes = notebook.notes
    new_note = Joplin::Note.new
    new_note.title = query
    divider = %Q(

<svg height="50" width="460">
  <style> .line { stroke-width: 1px; fill: black; stroke: black; } </style>
  <g id="triangle"><path d="M0 30 L200 25 Q 220 25 200 40 Z" class="line" /></g>
  <use xlink:href="#triangle" transform="scale(-1 1) translate(-450 0)"/>
  <circle cx="225" cy="32" r="8" class="line"/>
</svg>

)

    new_note.body = notes.map { |n| "\# #{n.title}\n\n#{n.body}" }.join(divider)
    new_note.save!
    puts "Saved: #{new_note.title} with id: #{new_note.id}"
  end
end

MyCLI.start(ARGV)
